<tr>
    <td colspan="3">
        <a target="_blank" href="{{ url('/product-management/view/variant', {'id-product-abstract': bundleProduct.idProductAbstract, 'id-product': bundleProduct.id, 'type': 'regular'}) }}">{{ bundleProduct.name }}</a> ({{ 'Sku' | trans }}: {{ bundleProduct.sku }})
    </td>
    <td>
        {{ bundleProduct.quantity }}
    </td>
    <td></td>
    <td data-qa="item-total-amount" data-qa-raw="{{ bundleProduct.sumPriceToPayAggregation }}">
        {% embed '@Sales/Detail/boxes/discounted-price.twig' with {subtotal: bundleProduct.sumSubtotalAggregation, priceToPay: bundleProduct.sumPriceToPayAggregation} %} {% endembed %}
    </td>
    <td>
        <ul class="list">
            {% for returnPolicyMessage in (bundleItems | first).returnPolicyMessages %}
                <li class="list__item">{{ returnPolicyMessage.value | trans(returnPolicyMessage.parameters) }}</li>
            {% endfor %}
        </ul>
    </td>
    <td class="state-history"></td>
</tr>

{% for orderItem in bundleItems %}
    <tr>
        {% if loop.index == 1 %}
            <td rowspan="{{ bundleItems | length + bundleProduct.productOptions | length }}">
                {{ form_row(returnBundleItem.isReturnable) }}
            </td>
            <td rowspan="{{ bundleItems | length }}">
                <img class="product-image" src="{{ bundleProduct.metadata.image }}"/>
            </td>
        {% endif %}
        <td>
            <div>
                <a target="_blank" href="{{ url('/product-management/view/variant', {'id-product-abstract': orderItem.idProductAbstract, 'id-product': orderItem.id, 'type': 'regular'}) }}">
                    {{ orderItem.name }}
                </a>
            </div>
            <div class="sku">
                {{ 'Sku' | trans }}: {{ orderItem.Sku }}
            </div>


            {% if loop.index == bundleItems | length %}
                <br><br>
                {{ form_row(returnBundleItem.reason) }}
                {{ form_row(returnBundleItem.customReason) }}
            {% endif %}
        </td>
        <td>{{ orderItem.quantity }}</td>
        <td>
            <div>
                {% embed '@Sales/Detail/boxes/discounted-price.twig' with {subtotal: orderItem.sumPrice, priceToPay: orderItem.sumPrice - orderItem.sumDiscountAmountFullAggregation | default(0)} %} {% endembed %}
            </div>
            <div class="tax-info">{{ "incl. %tax_amount% % tax" | trans({'%tax_amount%': orderItem.taxRate|default(0)}) }}</div>
        </td>
        <td></td>
        <td></td>
        <td>
            <div>
                <a href="{{ url('/oms/index/draw', {'process': orderItem.process, 'state': orderItem.state.name}) }}" target="_blank">{{ (orderItem.stateHistory | first).name }}</a> ({{ orderItem.process }})
            </div>
            {% if orderItem.stateHistory | length > 1 %}
                <div id="history_details_{{ orderItem.idSalesOrderItem }}" class="hidden">
                    {% for stateHistory in orderItem.stateHistory | slice(1) %}
                        <div>{{ stateHistory.name }} ({{ stateHistory.createdAt | formatDateTime }})</div>
                    {% endfor %}
                </div>

                <a id="history-btn-{{ orderItem.idSalesOrderItem }}" class="btn btn-sm more-history is-hidden" data-id="{{ orderItem.IdSalesOrderItem }}"><span class="show-more">{{ 'Show history' | trans }}</span><span class="show-less">{{ 'Hide history' | trans }}</span></a>
            {% endif %}
        </td>
    </tr>
{% endfor %}

{% include '@Sales/Detail/boxes/order-item-option.twig' with {
    orderItem: bundleProduct,
    order: order,
} only %}
